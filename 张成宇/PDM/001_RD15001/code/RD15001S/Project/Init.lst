C51 COMPILER V9.52.0.0   INIT                                                              08/18/2015 14:52:37 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE INIT
OBJECT MODULE PLACED IN .\Init.obj
COMPILER INVOKED BY: C:\Keil_v4\C51\BIN\C51.EXE ..\code\Init.c LARGE BROWSE INCDIR(..\code) DEBUG OBJECTEXTEND PRINT(.\I
                    -nit.lst) OBJECT(.\Init.obj)

line level    source

   1          #include <c8051f340.h>
   2          #include <intrins.h> 
   3          #include "uart.h" 
   4          #include "Init.h"
   5          /*********************************************
   6                          变量定义
   7          *********************************************/   
   8          static U32 xdata g_u32Tick = 0;  //1ms  
   9           /*********************************************
  10                   定时器2设置
  11          *********************************************/ 
  12          void timer2_init()                                                      // init timer2 as the system tick timer
  13          {
  14   1              TMR2CN    = 0x04;
  15   1              TMR2RLH   =0xf0; TMR2RLL   = 0x5f;              //1ms，1kHZ                                             // 16bit reload timer,sysclk/12 as clk. enable；1
             -ms every cycle; timer clock = 48MHz/12 = 4MHz; reload reg =0xffff - 4000 = 0xf05f;
  16   1              IE       |= 0x20;                                               //enable interrupt
  17   1              ET2       = 1;
  18   1      }
  19          
  20          void timer2_isr(void) interrupt 5       //25ms interrupt
  21          {
  22   1              TF2H = 0;                                               //clearn interrupt
  23   1              g_u32Tick++;
  24   1      }
  25          
  26          U32 GetTickCount(void)
  27          {
  28   1              return  g_u32Tick;
  29   1      }
  30          
  31          /*********************************************
  32                                  VDD监视器使能 
  33          *********************************************/ 
  34          // reset something       
  35          void reset_sources_init()
  36          {
  37   1          int i         = 0;
  38   1          VDM0CN    = 0x80;                           // 掉电复位/VDD监视器使能
  39   1          for (i = 0; i < 2400; i++)          // 等待100us
  40   1              {
  41   2                      ;
  42   2              }
  43   1      //    REG0CN    = 0x80;                 // 稳压器控制寄存器：关闭稳压器
  44   1      //    REF0CN    = 0x03;                 // 电压基准控制寄存器：                           
  45   1                                                                              //         1、内部模拟偏压发生器使能;              
  46   1                                                                              //         2、内部基准缓冲器被使能，内部电压基准被驱动到VREF引脚.
  47   1      }
  48          /*********************************************
  49                   PCA设置
  50          *********************************************/ 
  51          void PCA0_Init (void)
  52          {
  53   1         PCA0MD &= ~0x40;              // Disable the Watchdog Timer   //12分l
C51 COMPILER V9.52.0.0   INIT                                                              08/18/2015 14:52:37 PAGE 2   

  54   1      }
  55          
  56          /*********************************************
  57                   内部晶振设置
  58          *********************************************/ 
  59          void Oscillator_Init (void)
  60          {
  61   1      //      OSCICN = 0x83;                          // Set the internal oscillator to Select internal oscillator as input to clock multi
             -plier                                    // 12 MHz
  62   1      ////   CLKMUL  = 0x00;                     
  63   1      ////   CLKMUL |= 0x80;            // Enable clock multiplier
  64   1      ////   Delay();                   // Delay for clock multiplier to begin
  65   1      ////   CLKMUL |= 0xC0;            // Initialize the clock multiplier
  66   1      ////   Delay();                   // Delay for clock multiplier to begin
  67   1      ////   while(!(CLKMUL & 0x20));   // Wait for multiplier to lock
  68   1      ////   CLKSEL  = 0x03;            // Select system clock
  69   1      
  70   1          int i = 0;
  71   1      //    OSCICN    = 0x83;                 // Set the internal oscillator to Select internal oscillator as input to clock
             - multiplier   
  72   1      //    CLKMUL    = 0x80;                 // Enable clock multiplier
  73   1      //    for (i = 0; i < 20; i++);    // Wait 5us for initialization
  74   1      //    CLKMUL    |= 0xC0;                         // Initialize the clock multiplier
  75   1      //    while ((CLKMUL & 0x20) == 0);  // Wait for multiplier to lock
  76   1      
  77   1      //      OSCICN    = 0x83;                        //系统时钟12MHZ
  78   1          FLSCL     = 0x90;
  79   1          CLKMUL    = 0x80;
  80   1          for (i = 0; i < 20; i++);    // Wait 5us for initialization
  81   1          CLKMUL    |= 0xC0;
  82   1          while ((CLKMUL & 0x20) == 0);
  83   1          CLKSEL    = 0x03;
  84   1          OSCICN    = 0x83;
  85   1      }
  86          
  87          /*********************************************
  88                   端口初始化
  89          *********************************************/ 
  90          void PORT_Init (void)
  91          {
  92   1              P0MDOUT   = 0x90;
  93   1              P1MDOUT   = 0x60;
  94   1              P2MDOUT   = 0x10;
  95   1              P4MDOUT   = 0x03;
  96   1              P0SKIP    = 0xCF;
  97   1              P1SKIP    = 0x3F;
  98   1              XBR0      = 0x01;
  99   1              XBR1      = 0xC0;
 100   1              XBR2      = 0x01;
 101   1      
 102   1      
 103   1      
 104   1      //      P0MDOUT   = 0x90;
 105   1      //    P1MDOUT   = 0x40;
 106   1      //    P2MDOUT   = 0x10;
 107   1      //    P4MDOUT   = 0x03;
 108   1      //    P0SKIP    = 0x4F;
 109   1      //    P1SKIP    = 0x0F;
 110   1      //    XBR0      = 0x01;  // route UART 0 to crossbar
 111   1      //    XBR1      = 0xD1;
 112   1      //    XBR2      = 0x01; // route UART 1 to crossbar
 113   1      
C51 COMPILER V9.52.0.0   INIT                                                              08/18/2015 14:52:37 PAGE 3   

 114   1      }
 115          
 116          /*********************************************
 117                   初始化汇总
 118          *********************************************/          
 119          void Init_Device (void)
 120          {
 121   1         PCA0_Init ();                       // Disable the Watchdog Timer first
 122   1         reset_sources_init();
 123   1         Oscillator_Init ();
 124   1         PORT_Init ();
 125   1         UartInit();
 126   1         timer2_init();
 127   1      //   RfidInitProc();
 128   1      }
 129          /********************************************\
 130          |* 功能： 延时  晶振为48M时                                     *|
 131          \********************************************/
 132          void DelayUs(unsigned int t)
 133          {
 134   1        unsigned int i;
 135   1        unsigned int j;
 136   1           for(j=0;j<t;j++)
 137   1              for(i=3;i>0;i--);  //延时大约 1us
 138   1      }
 139          /********************************************\
 140          |* 功能： 延时  晶振为48M时                                     *|
 141          |* 延时大约 1ms                                                 *|
 142          \********************************************/ 
 143          void DelayMs(unsigned int t)
 144          {
 145   1        unsigned int i;
 146   1        unsigned int j;
 147   1        t=t*10;
 148   1        for(j=0;j<t;j++)
 149   1           for(i=390;i>0;i--);  //延时大约 1ms
 150   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    278    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

#include "ltc2402.h"

#define RCC_LTC2402_CONFIG()  RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE)

#define LTC2402_SPI1_SCK_PORT   GPIOA
#define LTC2402_SPI1_SCK_PIN    GPIO_Pin_5
#define LTC2402_SPI1_MISO_PORT  GPIOA
#define LTC2402_SPI1_MISO_PIN   GPIO_Pin_6


#define LTC2402_SPI1_CS1_PORT   GPIOA
#define LTC2402_SPI1_CS1_PIN    GPIO_Pin_4
#define LTC2402_SPI1_CS2_PORT   GPIOB
#define LTC2402_SPI1_CS2_PIN    GPIO_Pin_7
#define LTC2402_SPI1_CS3_PORT   GPIOB
#define LTC2402_SPI1_CS3_PIN    GPIO_Pin_6
#define LTC2402_SPI1_CS4_PORT   GPIOB
#define LTC2402_SPI1_CS4_PIN    GPIO_Pin_5

#define LTC2402_SPI1_CS1_H()    GPIO_SetBits(LTC2402_SPI1_CS1_PORT,LTC2402_SPI1_CS1_PIN)
#define LTC2402_SPI1_CS2_H()	GPIO_SetBits(LTC2402_SPI1_CS2_PORT,LTC2402_SPI1_CS2_PIN)
#define LTC2402_SPI1_CS3_H()	GPIO_SetBits(LTC2402_SPI1_CS3_PORT,LTC2402_SPI1_CS3_PIN)
#define LTC2402_SPI1_CS4_H()	GPIO_SetBits(LTC2402_SPI1_CS4_PORT,LTC2402_SPI1_CS4_PIN)

#define LTC2402_SPI1_CS1_L()    GPIO_ResetBits(LTC2402_SPI1_CS1_PORT,LTC2402_SPI1_CS1_PIN)
#define LTC2402_SPI1_CS2_L()	GPIO_ResetBits(LTC2402_SPI1_CS2_PORT,LTC2402_SPI1_CS2_PIN)
#define	LTC2402_SPI1_CS3_L()	GPIO_ResetBits(LTC2402_SPI1_CS3_PORT,LTC2402_SPI1_CS3_PIN)
#define LTC2402_SPI1_CS4_L()	GPIO_ResetBits(LTC2402_SPI1_CS4_PORT,LTC2402_SPI1_CS4_PIN)

#define LTC2402_CONTROL_CS_L	LTC2402_SPI1_CS4_L		
#define LTC2402_CONTROL_CS_H	LTC2402_SPI1_CS4_H

#define LTC2402_CONTROL_SCK_H   GPIO_SetBits(LTC2402_SPI1_SCK_PORT,LTC2402_SPI1_SCK_PIN)
#define LTC2402_CONTROL_SCK_L   GPIO_ResetBits(LTC2402_SPI1_SCK_PORT,LTC2402_SPI1_SCK_PIN)


VOID Ltc2402SoftInit(VOID)
{
    RCC_LTC2402_CONFIG();
    GPIO_Set(LTC2402_SPI1_CS1_PORT,LTC2402_SPI1_CS1_PIN,GPIO_Mode_Out_PP,GPIO_Speed_50MHz);
    GPIO_Set(LTC2402_SPI1_CS2_PORT,LTC2402_SPI1_CS2_PIN,GPIO_Mode_Out_PP,GPIO_Speed_50MHz);
    GPIO_Set(LTC2402_SPI1_CS3_PORT,LTC2402_SPI1_CS3_PIN,GPIO_Mode_Out_PP,GPIO_Speed_50MHz);
    GPIO_Set(LTC2402_SPI1_CS4_PORT,LTC2402_SPI1_CS4_PIN,GPIO_Mode_Out_PP,GPIO_Speed_50MHz);
    
    DelayMs_Sft(50);
    	
    LTC2402_SPI1_CS1_H();
    LTC2402_SPI1_CS2_H();
    LTC2402_SPI1_CS3_H();
    LTC2402_SPI1_CS4_H();
    	
	GPIO_Set(LTC2402_SPI1_SCK_PORT,LTC2402_SPI1_SCK_PIN,GPIO_Mode_Out_PP,GPIO_Speed_50MHz);//CLK推挽输出
	
	GPIO_Set(LTC2402_SPI1_MISO_PORT,LTC2402_SPI1_MISO_PIN,GPIO_Mode_IN_FLOATING,GPIO_Speed_50MHz); //MISO上拉输入
	
	//SCK高或者浮空时，在CS的下降沿会使得进入内部时钟模式,SCK在低时会进入外部时钟模式。
	GPIO_ResetBits(LTC2402_SPI1_SCK_PORT,LTC2402_SPI1_SCK_PIN);//设置进入外部时钟模式。
	LTC2402_CONTROL_CS_H();
	DelayMs(20);
	LTC2402_CONTROL_CS_L();
	DelayMs(20);
	LTC2402_CONTROL_CS_H();
    
	
	LTC2402_CONTROL_SCK_L;
    
    
}



U8 LTC2402_TEST_EOC_Start(VOID)
{
	LTC2402_CONTROL_CS_L(); 
	return LTC2402_ReadByte();
	
}

VOID LTC2402_TEST_EOC_End(VOID)
{
	LTC2402_CONTROL_CS_H(); 
	LTC2402_CONTROL_SCK_L;

}

U8 LTC2402_ReadByte(VOID)
{
	U8 count=0; 	  
	U8 x_data=0; 	 
	for(count=0;count<8;count++)  
	{ 				  
		x_data<<=1;
		
//		LTC2402_CONTROL_SCK_L;	//上升沿锁存
//		DelayUs_Sft(30);		 		
//		LTC2402_CONTROL_SCK_H;	
//		DelayUs_Sft(30);
//		if(GPIO_ReadInputDataBit(LTC2402_SPI1_MISO_PORT, LTC2402_SPI1_MISO_PIN))x_data++;		
		
		LTC2402_CONTROL_SCK_H;	//下降沿锁存
		
		DelayUs_Sft(30);
		if(GPIO_ReadInputDataBit(LTC2402_SPI1_MISO_PORT, LTC2402_SPI1_MISO_PIN))x_data++;	 		
		LTC2402_CONTROL_SCK_L;
			
		DelayUs_Sft(30);
			
			 
	}  		 
	return(x_data);   
}
